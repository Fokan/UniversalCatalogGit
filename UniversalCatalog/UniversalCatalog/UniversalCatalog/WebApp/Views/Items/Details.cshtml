@model WebApp.Models.Entities.Item

@{
    ViewBag.Title = "Details";
}

<h2>Details</h2>

<div>
    <h4>Item</h4>
    <input type="hidden" id="ItemId" value="@Model.Id" />
    <hr />
    <dl class="dl-horizontal">
        <dt>
            @Html.DisplayNameFor(model => model.Name)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Name)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Price)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Price)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.Type)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.Type.Name)
        </dd>

    </dl>
    <div>
        <div class="btn-group">
            <span style="text-align:center" class="btn btn-default">Опис</span>
             <input class="btn btn-primary" type="button" value="Edit" id="DescriptionEdit" />
        </div>
        <br />        
        @using (Html.BeginForm("EditDescriptions", "Items"))
        {
            <input type="hidden" value="@Model.Id" id="ItemId" name="ItemId" />
            <table class="table">
                <tbody>
                    @{ int i = 0;}
                    @foreach (var description in Model.Descriptions)
                    {
                        <tr>
                            <td>@description.Property.Name</td>
                            <td>
                                <input type="hidden" value="@description.Id" name="Descriptions[i].Id" />
                                
                                <textarea rows="4" class="form-control descriptions" data-id="@description.Id" name="Descriptions[i].Value" disabled="disabled">@description.Value</textarea>
                            </td>
                        </tr>
                        i++;
                    }
                </tbody>
            </table>
            <input type="button" value="Save" id="DescriptionsSave" style="display:none;" />
        }
    </div>


    <p>Images</p>
    <div id="images" style="display:inline-block;" >
        <div id="imagesBlock" style="display:flex;">
                @foreach (var image in Model.Images)
                {
                <div style="margin:10px;">
                    <img width="150" height="150" class="img-thumbnail" src="@Url.Action("GetImage", "Items", new { ImageId = image.Id })" alt="@Model.Name" /><br />
                    @*<input type="button" value="Delete" class="deleteImage" data-id="@image.Id" style="width:100%" />*@
                    @*@Html.ActionLink("Delete", "DeleteImage", "Items", new { ItemId = Model.Id, ImageId = image.Id }, htmlAttributes: new { @class = "form-control" })*@
                    <button type="button" class="btn btn-default deleteImage" data-id="@image.Id" >Delete</button>
                </div>
                }
        </div>
        <div style="display:inline-block; margin:10px; width:150px; height:184px; padding:20px; text-align:center; font-size:110px; background:grey;" id="fileupload">
            +
            @*<input type="file" id="file" name="image" style="display:none;" accept="image/jpeg,image/gif,image/x-png" />*@
            <form action='/Items/AddImage' enctype='multipart/form-data' method='post' id='temporaryForm' style='display:none;'>
                <input type='hidden' value='@Model.Id' name='ItemId'>
                <input type='file' id='file' name='File' style='display:none;' accept='image/jpeg,image/gif,image/x-png' />
                @*<input type='submit' name='imageLoad' id='imageLoad'>*@
            </form>
        </div>
    </div>
</div>
<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.Id }) |
    @Html.ActionLink("Back to List", "Index")
</p>

@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/jqueryval")

<script>
    $(document).ready(function () {
        $(document).on('click', '#fileupload', function () {
            $("#file").click();
        });
        $(document).on('click', '#file', function (e) {
            e.stopPropagation();
        });
        $(document).on('change', '#file', function () {
            //$('#temporaryForm').submit();
            var id=$("ItemId").val();
            var file=$("#file").file;
            
            $.ajax({
                url: "/Items/AddImage",
                data: { ItemId: id, File: file },
                success: function (id) {
                    var v = id;
                }
            });
        });

        //$("#temporaryForm").load(function (id) {
        //    var i = id;
        //});

        $(document).on('click', '.deleteImage', function () {
            var id = $(this).data("id");
            $.post("/Items/DeleteImage", { ImageId: id, ItemId: $("#ItemId").val()});
            $(this).parent().hide();
        });
        

        $(document).on('click', "#DescriptionEdit", function () {
            $(".descriptions").removeAttr("disabled");
            $("#DescriptionsSave").show();
        });
        $(document).on('click', "#DescriptionsSave", function () {
            $("#DescriptionsSave").hide();
            //$(".descriptions").css("disabled", "disabled");
            var descriptions = document.getElementsByClassName("descriptions");
            var Data = [];
            for(var i=0; i<descriptions.length; i++)
            {
                var id =$(descriptions[i]).data("id");
                var value = $(descriptions[i]).val();
                Data.push(new Array(id, value));
                descriptions[i].disabled = true;
            }
            var Id = $("#ItemId").val().toString();
            $.post("/items/EditDescriptions", { "ItemId": Id, "Descriptions": Data });
        });

        $(document).on('click', "#moreImage", function () {
            $("#images").append("<input type='file' name='Images' class='img-thumbnail' />");
        });

    });
</script>